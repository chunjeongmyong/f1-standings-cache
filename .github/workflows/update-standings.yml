name: Update F1 Standings Cache

on:
  schedule:
    - cron: "0 0 * * *" # 00:00 UTC (KST 09:00)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch standings (current, fallback to last)
        shell: bash
        run: |
          set -euo pipefail

          URL_CUR="https://api.jolpi.ca/ergast/f1/current/driverStandings.json"
          URL_LAST="https://api.jolpi.ca/ergast/f1/last/driverStandings.json"

          echo "Fetching current standings..."
          curl -fsSL "$URL_CUR" -o standings.json

          TOTAL="$(python3 -c 'import json; d=json.load(open("standings.json","r",encoding="utf-8")); print(d.get("MRData",{}).get("total","0"))')"
          echo "current total=$TOTAL"

          if [ "$TOTAL" = "0" ]; then
            echo "No current standings yet. Falling back to last season..."
            curl -fsSL "$URL_LAST" -o standings.json
          fi

          echo "standings.json bytes:"
          wc -c standings.json

      - name: Commit & push if changed
        shell: bash
        run: |
          set -euo pipefail

          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git add standings.json

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Update standings cache"
          git push
